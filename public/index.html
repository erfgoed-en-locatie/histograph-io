<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Histograph IO</title>
  <meta name="description" content="Histograph IO - Drag'n'drop file uploads!">
  <meta name="author" content="Bert Spaan">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <script src="js/dropzone.min.js"></script>
  <script src="js/d3.v3.min.js"></script>

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">

  <link rel="stylesheet" href="css/basic.min.css">
  <link rel="stylesheet" href="css/dropzone.min.css">

  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <div class="row">
      <h1>Histograph IO</h1>
      <p>
        Drag'n'drop <a href="http://ndjson.org/">NDJSON</a> files into Histograph! Files must be named <code>&lt;layer&gt;.pits.ndjson</code> or <code>&lt;layer&gt;.relations.ndjson</code>, and adhere to <a href="https://github.com/erfgoed-en-locatie/histograph-io/tree/master/schemas">Histograph's JSON schemas</a>.
      </p>
      <form action="/layers" class="dropzone" id="histograph"></form>
      <h2>Layers</h2>
      <p id="layers"></p>
    </div>
  </div>
  <script>
    d3.json('/layers', function(json) {
      d3.select("#layers").selectAll("span")
          .data(json).enter()
        .append("span")
          .each(function(d, i) {
            d3.select(this).append("code").append("a")
                .attr("href", "/layers/" + d.name)
                .html(d.name)
            if (i < json.length - 1) {
              d3.select(this).html(d3.select(this).html() + ", ");
            }
          });
    });
  </script>
  <script>
    function urlFromFilename(filename) {
      var fileElements = filename.split(".");
      if (fileElements.length == 3) {
        return "/layers/" + fileElements[0] + "/" + fileElements[1] + "." + fileElements[2];
      } else {
        return null;
      }
    }

    Dropzone.options.histograph = {
      clickable: false,
      maxFilesize: 1024, // MB
      acceptedFiles: ".ndjson,.json",
      init: function() {
        this.on("processing", function(file) {
          this.options.url = urlFromFilename(file.name);
        });
      },
      accept: function(file, done) {
        // file.name must use naming convention: "source.type.extension";
        var fileElements = file.name.split(".");
        if (fileElements.length == 3) {
          var url = "/layers/" + fileElements[0] + "/" + fileElements[1] + "." + fileElements[2];
          done();
        } else {
          done("Please use correct naming convention for file!");
        }
      }
    };
  </script>
</body>
</html>